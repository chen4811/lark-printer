name: Deploy to GitHub Pages

on:
  push:
    branches: ['main']  # 监听main分支推送
  schedule:
    - cron: "0 2 * * *"  # 每日UTC 2点定时部署（北京时间10点）
  workflow_dispatch:  # 支持手动触发

permissions:
  contents: read       # 仅读取代码权限
  pages: write         # 写入Pages资源权限
  id-token: write      # 生成身份令牌权限

concurrency:
  group: 'pages'       # 并发控制组名
  cancel-in-progress: true  # 取消正在进行的旧任务

jobs:
  build-and-deploy:
    environment:
      name: github-pages  # 关联GitHub Pages环境
      url: ${{ steps.deployment.outputs.page_url }}  # 输出部署URL
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整提交历史

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # 匹配项目Node版本
          cache: 'npm'        # 自动缓存npm依赖

      - name: Install dependencies
        run: npm ci  # 严格按package-lock.json安装依赖

      - name: Build project
        run: npm run build-only  # 执行项目构建命令
        env:
          NODE_ENV: production  # 生产环境构建

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v4  # 官方Pages配置工具

      - name: Upload build artifacts
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'  # 构建产物目录，根据项目实际情况调整

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4  # 官方部署工具
    
